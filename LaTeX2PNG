#!/bin/bash

PDFFILE="PDFOutput"
TEXFILE="Template"
PNGFILE="PNGOutput"

if [[ $# -gt 1 ]]; then
    CUSTOMIZE=1
fi

while [[ $# -gt 1 ]]; do
    KEY="$1"

    case $KEY in
        -l|--line)
            LINE="$2"
            shift
            ;;
        -b|--border)
            BORDER="$2"
            shift
            ;;
        -g|--background)
            BACKGROUND="$2"
            shift
            ;;
        -d|--displaystyle)
            DISPLAYSTYLE="$2"
            shift
            ;;
        -i|--input)
            INPUTPATH="$2"
            shift
            ;;
        -o|--output)
            OUTPUTPATH="$2"
            shift
            ;;
        --default)
            DEFAULT=YES
            ;;
        *)

            ;;
    esac
    shift
done

if [[ $CUSTOMIZE = "1" ]]; then
    cat $TEXFILE.tex > tmp.tex
    TEXFILE=tmp
fi
if [[ -n $LINE ]]; then
    sed -ie '/[\\\]begin{document}/,/[\\\]end{document}/d' $TEXFILE.tex
    echo $"\\begin{document}$LINE\\end{document}" >> tmp.tex
fi

if [[ -f $TEXFILE.tex ]]; then
    if pdflatex $TEXFILE.tex && mv $TEXFILE.pdf $PDFFILE.pdf; then
        REMOVE=1
    else
        echo "Error occurs when compiling the TeX file into PDF file."
    fi
else
    echo "The TeX file $TEXFILE.tex does not exist."
fi
echo "PDF file generated."
if [[ $REMOVE = "1" ]]; then
    if rm $TEXFILE.aux $TEXFILE.log; then
        echo ".aux and .log files removed."
    else
        echo "Cannot remove .aux and .log files."
    fi
    if [[ -f $TEXFILE.texe ]]; then
        rm $TEXFILE.texe
        echo ".texe file removed."
    fi
fi
if [[ -f $PDFFILE.pdf ]]; then
    echo "Generating PNG image from PDF file."
    if convert -density 800 $PDFFILE.pdf -quality 800 -background white -alpha remove $PNGFILE.png; then
        echo "PNG image successfully generated!"
    else
        echo "Failed to generate PNG image."
    fi
else
    echo "The PDF file $PDFFILE.pdf does not exist."
fi
#if [[ $CUSTOMIZE = "1" ]]; then
#    rm tmp.tex
#fi
